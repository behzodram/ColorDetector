<!DOCTYPE html>
<html>
<head>
    <title>Color Sprint Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --chat-width: 320px;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            background: #f5f5f5;
            touch-action: manipulation;
            overflow-x: hidden;
            position: relative;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            transition: transform 0.3s ease;
        }
        
        /* Mobile Header */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }
        
        .mobile-header h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--dark);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-toggle-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chat-toggle-btn:hover {
            background: #2980b9;
        }
        
        .pause-indicator {
            background: var(--warning);
            color: var(--dark);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            display: none;
        }
        
        /* Chat Sidebar */
        .chat-sidebar {
            position: fixed;
            top: 0;
            left: -100%;
            width: var(--chat-width);
            height: 100vh;
            background: white;
            box-shadow: 2px 0 20px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .chat-sidebar.open {
            left: 0;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: var(--primary);
            color: white;
        }
        
        .chat-header h3 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
        }
        
        .chat-username {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .chat-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .chat-close-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }
        
        /* Overlay */
        .chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .chat-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Game content adjustment */
        .game-content {
            margin-top: 70px;
            transition: transform 0.3s ease;
        }
        
        .game-paused .game-content {
            transform: translateX(calc(var(--chat-width) / 2));
        }
        
        #login-screen, #game-screen, #stats-screen, #end-screen, #level-locked-screen {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            margin: 0 auto;
        }
        
        #game-screen, #stats-screen, #end-screen, #level-locked-screen {
            display: none;
        }
        
        h1, h2, h3 {
            color: var(--dark);
            margin-bottom: 15px;
        }
        
        h1 {
            font-size: 1.5rem;
        }
        
        h2 {
            font-size: 1.3rem;
        }
        
        h3 {
            font-size: 1.1rem;
        }
        
        input, button, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 1rem;
            -webkit-appearance: none;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        #target {
            font-size: 1.5rem;
            margin: 15px 0;
            padding: 12px 20px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: inline-block;
            font-weight: bold;
        }
        
        #options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .option {
            aspect-ratio: 1/1;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0;
        }
        
        .option:active {
            transform: scale(0.95);
        }
        
        #game-info {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            gap: 10px;
        }
        
        .info-box {
            background: var(--light);
            padding: 8px 12px;
            border-radius: 8px;
            flex: 1;
            font-size: 0.9rem;
        }
        
        .feedback {
            position: fixed;
            font-size: 2.5rem;
            font-weight: bold;
            opacity: 0;
            transition: all 0.5s;
            z-index: 100;
            pointer-events: none;
        }
        
        #level-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin: 15px 0;
        }
        
        .level-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1rem;
            padding: 0;
        }
        
        .level-btn.active {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .level-btn.locked {
            background-color: #95a5a6;
            position: relative;
        }
        
        .level-btn.locked::after {
            content: "üîí";
            position: absolute;
            font-size: 0.7rem;
            top: -5px;
            right: -5px;
        }
        
        .level-btn.hard {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #leaderboard-preview {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .leaderboard-item.highlight {
            font-weight: bold;
            color: var(--primary);
        }
        
        .time-filter {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
        }
        
        .time-filter button {
            flex: 1;
            padding: 8px;
            font-size: 0.8rem;
        }
        
        .time-filter button.active {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        #back-btn, #play-again-btn {
            background-color: var(--danger);
            margin-top: 15px;
        }
        
        #continue-btn {
            background-color: var(--secondary);
            margin-top: 15px;
        }
        
        #unlock-btn {
            background-color: var(--warning);
            color: var(--dark);
            margin-top: 15px;
        }
        
        .selecting {
            position: absolute;
            width: 44px;
            height: 44px;
            border: 2px dashed var(--warning);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
            transition: all 0.3s ease-out;
        }
        
        /* Table styles for leaderboard */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light);
            font-weight: bold;
        }
        
        tr.highlight {
            background-color: rgba(52, 152, 219, 0.1);
            font-weight: bold;
        }
        
        /* Comments Section Styles - Adapted for Chat */
        .comment-form {
            margin-bottom: 15px;
            position: relative;
        }
        
        .comment-input-container {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 20px;
            border: 2px solid #e8e8e8;
            transition: border-color 0.2s;
        }
        
        .comment-input-container:focus-within {
            border-color: var(--primary);
        }
        
        .comment-form textarea {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            padding: 8px 0;
            font-size: 0.9rem;
            max-height: 100px;
            min-height: 20px;
            overflow-y: auto;
            margin: 0;
            outline: none;
            font-family: inherit;
            line-height: 1.4;
        }
        
        .comment-form textarea::placeholder {
            color: #999;
        }
        
        .send-btn {
            background: var(--primary);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0;
            padding: 0;
            flex-shrink: 0;
        }
        
        .send-btn:hover:not(:disabled) {
            background: #2980b9;
            transform: scale(1.05);
        }
        
        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .send-btn svg {
            width: 16px;
            height: 16px;
            fill: white;
            transform: translateX(1px);
        }
        
        .char-counter {
            position: absolute;
            bottom: -20px;
            right: 0;
            font-size: 0.7rem;
            color: #999;
        }
        
        .char-counter.warning {
            color: var(--warning);
        }
        
        .char-counter.danger {
            color: var(--danger);
        }
        
        .comment-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid var(--primary);
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .comment-author {
            font-weight: bold;
            color: var(--dark);
        }
        
        .comment-time {
            color: #666;
        }
        
        .comment-text {
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .comment-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .like-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 4px 8px;
            border-radius: 15px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            width: auto;
            margin: 0;
        }
        
        .like-btn.liked {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .like-btn:hover {
            background: #f0f0f0;
        }
        
        .like-btn.liked:hover {
            background: #27ae60;
        }
        
        .reply-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 4px 8px;
            border-radius: 15px;
            color: #666;
            cursor: pointer;
            font-size: 0.8rem;
            width: auto;
            margin: 0;
        }
        
        .reply-btn:hover {
            background: #f0f0f0;
        }
        
        .replies {
            margin-top: 10px;
            margin-left: 15px;
            border-left: 2px solid #e8e8e8;
            padding-left: 10px;
        }
        
        .reply-form {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
        }
        
        .reply-form textarea {
            font-size: 0.85rem;
            min-height: 60px;
        }
        
        .reply-form button {
            font-size: 0.8rem;
            padding: 6px 12px;
        }
        
        .sort-controls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .sort-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            width: auto;
            margin: 0;
        }
        
        .sort-btn.active {
            background-color: var(--primary);
        }
        
        .comments-empty {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 20px;
        }
        
        .dev-apps-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--warning);
            color: var(--dark);
            border: none;
            border-radius: 25px;
            padding: 10px 15px;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 999;
            width: auto;
            margin: 0;
            transition: all 0.3s;
        }
        
        .dev-apps-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* Mobile optimizations */
        @media (max-width: 400px) {
            :root {
                --chat-width: 280px;
            }
            
            .container {
                padding: 10px;
            }
            
            .mobile-header {
                padding: 0 15px;
            }
            
            .mobile-header h1 {
                font-size: 1rem;
            }
            
            .chat-toggle-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            #options {
                gap: 8px;
            }
            
            .info-box {
                padding: 6px 8px;
                font-size: 0.8rem;
            }
            
            #target {
                font-size: 1.2rem;
                padding: 10px 15px;
            }
            
            .time-filter button {
                font-size: 0.7rem;
                padding: 5px;
            }
            
            th, td {
                padding: 5px;
                font-size: 0.85rem;
            }
            
            .comment-item {
                padding: 10px;
            }
            
            .comment-text {
                font-size: 0.85rem;
            }
            
            .dev-apps-btn {
                bottom: 15px;
                right: 15px;
                padding: 8px 12px;
                font-size: 0.7rem;
            }
        }
        
        /* Hide original comments section in game screen */
        #game-screen #comments-section {
            display: none;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-database-compat.min.js"></script>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header" id="mobile-header" style="display: none;">
        <h1>Color Sprint Pro</h1>
        <div class="header-controls">
            <div class="pause-indicator" id="pause-indicator">PAUSED</div>
            <button class="chat-toggle-btn" id="chat-toggle-btn">
                üí¨ Chat
            </button>
        </div>
    </div>
    
    <!-- Chat Overlay -->
    <div class="chat-overlay" id="chat-overlay"></div>
    
    <!-- Chat Sidebar -->
    <div class="chat-sidebar" id="chat-sidebar">
        <div class="chat-header">
            <h3>üí¨ Game Chat</h3>
            <div class="chat-username" id="chat-username">Welcome!</div>
            <button class="chat-close-btn" id="chat-close-btn">√ó</button>
        </div>
        <div class="chat-content">
            <div class="chat-messages" id="chat-messages">
                <div class="sort-controls">
                    <button class="sort-btn active" data-sort="recent">Most Recent</button>
                    <button class="sort-btn" data-sort="liked">Most Liked</button>
                </div>
                <div id="comments-list">
                    <div class="comments-empty">Loading chat...</div>
                </div>
            </div>
            <div class="chat-input-area">
                <div class="comment-form">
                    <div class="comment-input-container">
                        <textarea id="new-comment" placeholder="Share your thoughts..." maxlength="500"></textarea>
                        <button class="send-btn" id="post-comment" disabled>
                            <svg viewBox="0 0 24 24">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="char-counter" id="char-counter">0/500</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="game-content">
        <div class="container">
            <!-- Login Screen -->
            <div id="login-screen">
                <h1>Color Sprint Pro</h1>
                <p>Test your color recognition skills!</p>
                <input type="text" id="username" placeholder="Enter your username" autocapitalize="none">
                <button id="start-btn">Start Game</button>
                <div id="login-error" style="color: var(--danger); margin-top: 10px; display: none;"></div>
            </div>
            
            <!-- Game Screen -->
            <div id="game-screen">
                <h1>Level <span id="current-level">1</span></h1>
                
                <div id="game-info">
                    <div class="info-box">Time: <span id="timer">30</span>s</div>
                    <div class="info-box">Score: <span id="score">0</span></div>
                    <div class="info-box">Hi-score: <span id="hi-score">0</span></div>
                </div>
                
                <div id="target">Color Name</div>
                
                <div id="options"></div>
                
                <div id="leaderboard-preview">
                    <h3>Top Players - Level <span id="current-level-display">1</span></h3>
                    <div id="top-leaderboard">
                        <div class="leaderboard-item"><span>Loading...</span></div>
                    </div>
                </div>
                
                <div id="level-selector">
                    <!-- Levels will be added dynamically -->
                </div>
                
                <button id="stats-btn">View Stats</button>
            </div>
            
            <!-- Stats Screen -->
            <div id="stats-screen">
                <h1>Game Statistics</h1>
                <h2 id="stats-username"></h2>
                
                <h3>Overall Performance</h3>
                <div id="overall-stats"></div>
                
                <h3>Level Leaderboards</h3>
                <select id="leaderboard-select">
                    <!-- Options will be added dynamically -->
                </select>
                
                <div class="time-filter">
                    <button class="time-btn active" data-time="all">All Time</button>
                    <button class="time-btn" data-time="week">This Week</button>
                    <button class="time-btn" data-time="today">Today</button>
                </div>
                
                <div id="leaderboard-container"></div>
                
                <button id="back-btn">Back to Game</button>
            </div>
            
            <!-- End Game Screen -->
            <div id="end-screen">
                <h1>Game Over!</h1>
                <h2>Level <span id="end-level">1</span></h2>
                
                <div class="info-box" style="margin: 15px auto; max-width: 200px;">
                    Your Score: <span id="end-score">0</span>
                </div>
                
                <div class="info-box" style="margin: 15px auto; max-width: 200px;">
                    Hi-score: <span id="end-hiscore">0</span>
                </div>
                
                <div id="level-unlock-message" style="display: none; margin: 15px 0; padding: 10px; background-color: var(--secondary); color: white; border-radius: 5px;">
                    üéâ Level unlocked! You can now play Level <span id="unlocked-level">2</span>!
                </div>
                
                <button id="play-again-btn">Play Again</button>
                <button id="continue-btn">Next Level</button>
                <button id="end-stats-btn">View Stats</button>
            </div>
            
            <!-- Level Locked Screen -->
            <div id="level-locked-screen">
                <h1>Level Locked!</h1>
                <p>You need to complete level <span id="required-level">1</span> with at least 50 points first!</p>
                <button id="unlock-btn">Go to Level <span id="unlock-level">1</span></button>
                <button id="locked-back-btn">Back to Game</button>
            </div>
        </div>
    </div>
    
    <!-- Dev Apps Button -->
    <button class="dev-apps-btn" onclick="window.open('https://behzodram.github.io/Portfolio/', '_blank')">
        üîó Dev another apps
    </button>
    
    <div class="feedback" id="feedback"></div>
    <div class="selecting" id="selecting-indicator" style="display: none;"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB6KORcPrlTQdwHbjAiVmxdgIGJ2A3FCp4",
            authDomain: "colordetector-a7a71.firebaseapp.com",
            databaseURL: "https://colordetector-a7a71-default-rtdb.firebaseio.com",
            projectId: "colordetector-a7a71",
            storageBucket: "colordetector-a7a71.appspot.com",
            messagingSenderId: "643341320351",
            appId: "1:643341320351:web:71c2aec0877441a837a2aa"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Game variables
        let currentUsername = null;
        let score = 0;
        let hiScore = 0;
        let timeLeft = 30;
        let timer;
        let currentLevel = 1;
        let maxUnlockedLevel = 1;
        let colors = [];
        let correctIndex;
        let timeFilter = 'all';
        let gameActive = false;
        let gameStartTime = 0;
        let lastUpdateTime = 0;
        let currentCommentSort = 'recent';
        let gamePaused = false;
        let chatOpen = false;
        
        // Color database
        const colorNames = [
            'Red', 'Blue', 'Green', 'Yellow', 
            'Purple', 'Navy', 'White', 'Black',
            'Gray', 'Brown', 'Pink', 'Orange',
            'Teal', 'Sky', 'Lime', 'Coral',
            'Gold', 'Silver', 'Maroon', 'Olive',
            'Violet', 'Indigo', 'Cyan', 'Magenta',
            'Beige', 'Mint', 'Lavender', 'Ruby',
            'Emerald', 'Sapphire'
        ];
        
        const colorValues = [
            '#e74c3c', '#3498db', '#2ecc71', '#f1c40f',
            '#9b59b6', '#2980b9', '#ecf0f1', '#2c3e50',
            '#95a5a6', '#a67c52', '#ff9ff3', '#feca57',
            '#1dd1a1', '#54a0ff', '#badc58', '#ff6b6b',
            '#ffd700', '#c0c0c0', '#800000', '#808000',
            '#ee82ee', '#4b0082', '#00ffff', '#ff00ff',
            '#f5f5dc', '#98ff98', '#e6e6fa', '#e0115f',
            '#50c878', '#0f52ba'
        ];
        
        // DOM elements
        const loginScreen = document.getElementById('login-screen');
        const gameScreen = document.getElementById('game-screen');
        const statsScreen = document.getElementById('stats-screen');
        const endScreen = document.getElementById('end-screen');
        const lockedScreen = document.getElementById('level-locked-screen');
        const usernameInput = document.getElementById('username');
        const startBtn = document.getElementById('start-btn');
        const loginError = document.getElementById('login-error');
        const statsBtn = document.getElementById('stats-btn');
        const backBtn = document.getElementById('back-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const continueBtn = document.getElementById('continue-btn');
        const endStatsBtn = document.getElementById('end-stats-btn');
        const unlockBtn = document.getElementById('unlock-btn');
        const lockedBackBtn = document.getElementById('locked-back-btn');
        const levelSelector = document.getElementById('level-selector');
        const timeBtns = document.querySelectorAll('.time-btn');
        const selectingIndicator = document.getElementById('selecting-indicator');
        const leaderboardSelect = document.getElementById('leaderboard-select');
        
        // Mobile/Chat elements
        const mobileHeader = document.getElementById('mobile-header');
        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const chatSidebar = document.getElementById('chat-sidebar');
        const chatOverlay = document.getElementById('chat-overlay');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const pauseIndicator = document.getElementById('pause-indicator');
        const chatUsername = document.getElementById('chat-username');
        
        // Comments elements
        const newCommentTextarea = document.getElementById('new-comment');
        const postCommentBtn = document.getElementById('post-comment');
        const commentsList = document.getElementById('comments-list');
        const sortBtns = document.querySelectorAll('.sort-btn');
        const charCounter = document.getElementById('char-counter');
        
        // Chat functionality
        function toggleChat() {
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                openChat();
            } else {
                closeChat();
            }
        }
        
        function openChat() {
            chatOpen = true;
            chatSidebar.classList.add('open');
            chatOverlay.classList.add('active');
            document.body.classList.add('game-paused');
            
            // Pause game if active
            if (gameActive && !gamePaused) {
                pauseGame();
            }
            
            // Update chat username
            if (currentUsername) {
                chatUsername.textContent = `Playing as: ${currentUsername}`;
            }
            
            // Load comments if not loaded
            loadComments();
        }
        
        function closeChat() {
            chatOpen = false;
            chatSidebar.classList.remove('open');
            chatOverlay.classList.remove('active');
            document.body.classList.remove('game-paused');
            
            // Resume game if it was paused by chat
            if (gamePaused && gameActive) {
                resumeGame();
            }
        }
        
        function pauseGame() {
            if (!gameActive) return;
            
            gamePaused = true;
            clearInterval(timer);
            pauseIndicator.style.display = 'block';
            chatToggleBtn.textContent = '‚ñ∂Ô∏è Resume';
            
            // Disable game interactions
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                option.style.pointerEvents = 'none';
                option.style.opacity = '0.5';
            });
        }
        
        function resumeGame() {
            if (!gameActive || !gamePaused) return;
            
            gamePaused = false;
            pauseIndicator.style.display = 'none';
            chatToggleBtn.textContent = 'üí¨ Chat';
            
            // Re-enable game interactions
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                option.style.pointerEvents = 'auto';
                option.style.opacity = '1';
            });
            
            // Restart timer
            timer = setInterval(() => {
                if (gameActive && !gamePaused && timeLeft > 0) {
                    timeLeft--;
                    document.getElementById('timer').textContent = timeLeft;
                    
                    if (timeLeft <= 0) {
                        endGame();
                    }
                }
            }, 1000);
        }
        
        // Event listeners for chat
        chatToggleBtn.addEventListener('click', toggleChat);
        chatCloseBtn.addEventListener('click', closeChat);
        chatOverlay.addEventListener('click', closeChat);
        
        // Prevent chat close when clicking inside sidebar
        chatSidebar.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        startBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            if (username && username.length >= 3) {
                loginError.style.display = 'none';
                startBtn.disabled = true;
                startBtn.textContent = 'Loading...';
                
                currentUsername = username;
                
                // Show mobile header and game
                mobileHeader.style.display = 'flex';
                loginScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                
                // Initialize with defaults and start game right away
                hiScore = 0;
                maxUnlockedLevel = 1;
                document.getElementById('hi-score').textContent = '0';
                document.getElementById('top-leaderboard').innerHTML = '<div class="leaderboard-item"><span>Loading...</span></div>';
                commentsList.innerHTML = '<div class="comments-empty">Loading comments...</div>';
                
                initializeLevelButtons();
                initializeLeaderboardSelect();
                startGame();
                
                // Load all data in background without blocking
                loadUserDataOptimized().then(() => {
                    updateHiScore();
                    initializeLevelButtons();
                });
                updateTopLeaderboard();
                loadComments();
                
            } else {
                loginError.textContent = 'Username must be at least 3 characters long.';
                loginError.style.display = 'block';
            }
        });
        
        // Comments event listeners
        newCommentTextarea.addEventListener('input', function() {
            const length = this.value.length;
            const maxLength = 500;
            
            // Update character counter
            charCounter.textContent = `${length}/${maxLength}`;
            
            // Update counter color
            charCounter.className = 'char-counter';
            if (length > maxLength * 0.8) {
                charCounter.classList.add('warning');
            }
            if (length > maxLength * 0.95) {
                charCounter.classList.remove('warning');
                charCounter.classList.add('danger');
            }
            
            // Enable/disable send button
            postCommentBtn.disabled = length === 0 || length > maxLength || !currentUsername;
            
            // Auto-resize textarea
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });
        
        newCommentTextarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!postCommentBtn.disabled) {
                    postComment();
                }
            }
        });
        
        postCommentBtn.addEventListener('click', postComment);
        
        sortBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                currentCommentSort = this.dataset.sort;
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                loadComments();
            });
        });
        
        // Other event listeners
        statsBtn.addEventListener('click', showStats);
        backBtn.addEventListener('click', () => {
            statsScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            mobileHeader.style.display = 'flex';
        });
        
        playAgainBtn.addEventListener('click', () => {
            endScreen.style.display = 'none';
            mobileHeader.style.display = 'flex';
            resetGame();
        });
        
        continueBtn.addEventListener('click', () => {
            endScreen.style.display = 'none';
            mobileHeader.style.display = 'flex';
            if (currentLevel < 10) {
                currentLevel++;
                updateActiveLevelButton();
                updateTopLeaderboard();
                resetGame();
            } else {
                currentLevel = 1;
                updateActiveLevelButton();
                updateTopLeaderboard();
                resetGame();
            }
        });
        
        endStatsBtn.addEventListener('click', () => {
            endScreen.style.display = 'none';
            showStats();
        });
        
        unlockBtn.addEventListener('click', () => {
            lockedScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            mobileHeader.style.display = 'flex';
            currentLevel = parseInt(document.getElementById('unlock-level').textContent);
            updateActiveLevelButton();
            updateTopLeaderboard();
            resetGame();
        });
        
        lockedBackBtn.addEventListener('click', () => {
            lockedScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            mobileHeader.style.display = 'flex';
        });
        
        // Leaderboard select change
        leaderboardSelect.addEventListener('change', updateLeaderboard);
        
        // Time filter buttons
        timeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                timeFilter = this.dataset.time;
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                updateLeaderboard();
            });
        });
        
        // Comments functions
        async function postComment() {
            const commentText = newCommentTextarea.value.trim();
            if (!commentText || !currentUsername || postCommentBtn.disabled) return;
            
            try {
                // Optimistic UI update
                const tempComment = {
                    id: 'temp-' + Date.now(),
                    author: currentUsername,
                    text: commentText,
                    timestamp: Date.now(),
                    likes: 0,
                    likedBy: {},
                    replies: {},
                    sending: true
                };
                
                // Add to UI immediately
                const comments = getCurrentComments();
                comments.unshift(tempComment);
                renderComments(comments);
                
                // Clear input
                newCommentTextarea.value = '';
                newCommentTextarea.style.height = 'auto';
                charCounter.textContent = '0/500';
                charCounter.className = 'char-counter';
                postCommentBtn.disabled = true;
                
                // Send to Firebase
                const commentData = {
                    author: currentUsername,
                    text: commentText,
                    timestamp: Date.now(),
                    likes: 0,
                    likedBy: {},
                    replies: {}
                };
                
                await database.ref('comments').push(commentData);
                
                // Reload comments to get real data
                setTimeout(() => loadComments(), 500);
                
            } catch (error) {
                console.warn('Error posting comment:', error);
                showToast('Failed to post comment. Please try again.', 'error');
                loadComments();
            }
        }
        
        function getCurrentComments() {
            // Get current comments from DOM for optimistic updates
            const commentElements = commentsList.querySelectorAll('.comment-item');
            const comments = [];
            
            commentElements.forEach(element => {
                if (!element.dataset.parsed) {
                    const authorEl = element.querySelector('.comment-author');
                    const textEl = element.querySelector('.comment-text');
                    const timeEl = element.querySelector('.comment-time');
                    const likeBtn = element.querySelector('.like-btn');
                    
                    if (authorEl && textEl && timeEl) {
                        comments.push({
                            id: element.dataset.id || 'unknown-' + Date.now(),
                            author: authorEl.textContent.trim(),
                            text: textEl.textContent.trim(),
                            timestamp: Date.now(), // Approximate
                            likes: parseInt(likeBtn ? likeBtn.textContent.replace('üëç', '').trim() : '0') || 0,
                            likedBy: {},
                            replies: {}
                        });
                    }
                }
            });
            
            return comments;
        }
        
        async function loadComments() {
            try {
                // Add timeout to prevent hanging
                const commentsPromise = database.ref('comments').once('value');
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Comments loading timeout')), 3000)
                );
                
                const snapshot = await Promise.race([commentsPromise, timeoutPromise]);
                const commentsData = snapshot.val() || {};
                
                const comments = Object.keys(commentsData).map(key => ({
                    id: key,
                    ...commentsData[key]
                }));
                
                // Sort comments
                if (currentCommentSort === 'liked') {
                    comments.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                } else {
                    comments.sort((a, b) => b.timestamp - a.timestamp);
                }
                
                renderComments(comments);
            } catch (error) {
                console.warn('Error loading comments:', error);
                commentsList.innerHTML = '<div class="comments-empty">Comments will load shortly...</div>';
                
                // Retry after delay
                setTimeout(() => {
                    database.ref('comments').once('value').then(snapshot => {
                        const commentsData = snapshot.val() || {};
                        const comments = Object.keys(commentsData).map(key => ({
                            id: key,
                            ...commentsData[key]
                        }));
                        if (currentCommentSort === 'liked') {
                            comments.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                        } else {
                            comments.sort((a, b) => b.timestamp - a.timestamp);
                        }
                        renderComments(comments);
                    }).catch(() => {
                        commentsList.innerHTML = '<div class="comments-empty">No comments yet. Be the first to share your thoughts!</div>';
                    });
                }, 2000);
            }
        }
        
        function renderComments(comments) {
            if (comments.length === 0) {
                commentsList.innerHTML = '<div class="comments-empty">No comments yet. Be the first to share your thoughts!</div>';
                return;
            }
            
            commentsList.innerHTML = comments.map(comment => {
                const sendingClass = comment.sending ? 'style="opacity: 0.6;"' : '';
                const sendingIndicator = comment.sending ? '<span style="font-size:0.7rem;color:#999;"> ‚Ä¢ Sending...</span>' : '';
                
                return `
                <div class="comment-item" data-id="${comment.id}" ${sendingClass}>
                    <div class="comment-header">
                        <span class="comment-author">${escapeHtml(comment.author)}</span>
                        <span class="comment-time">${formatTime(comment.timestamp)}${sendingIndicator}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                    <div class="comment-actions">
                        <button class="like-btn ${comment.likedBy && comment.likedBy[currentUsername] ? 'liked' : ''}" 
                                onclick="toggleLike('${comment.id}')" ${comment.sending ? 'disabled' : ''}>
                            üëç ${comment.likes || 0}
                        </button>
                        <button class="reply-btn" onclick="toggleReplyForm('${comment.id}')" ${comment.sending ? 'disabled' : ''}>
                            üí¨ Reply
                        </button>
                    </div>
                    <div class="reply-form" id="reply-form-${comment.id}">
                        <textarea placeholder="Write a reply..." id="reply-text-${comment.id}" maxlength="300"></textarea>
                        <button onclick="postReply('${comment.id}')">Post Reply</button>
                        <button onclick="cancelReply('${comment.id}')">Cancel</button>
                    </div>
                    ${renderReplies(comment.replies || {}, comment.id)}
                </div>
            `}).join('');
        }
        
        function renderReplies(replies, parentId) {
            const repliesArray = Object.keys(replies).map(key => ({
                id: key,
                ...replies[key]
            }));
            
            if (repliesArray.length === 0) return '';
            
            repliesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            return `
                <div class="replies">
                    ${repliesArray.map(reply => `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span class="comment-author">${escapeHtml(reply.author)}</span>
                                <span class="comment-time">${formatTime(reply.timestamp)}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(reply.text)}</div>
                            <div class="comment-actions">
                                <button class="like-btn ${reply.likedBy && reply.likedBy[currentUsername] ? 'liked' : ''}" 
                                        onclick="toggleReplyLike('${parentId}', '${reply.id}')">
                                    üëç ${reply.likes || 0}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        async function toggleLike(commentId) {
            if (!currentUsername || commentId.startsWith('temp-')) return;
            
            try {
                const commentRef = database.ref(`comments/${commentId}`);
                const snapshot = await commentRef.once('value');
                const comment = snapshot.val();
                
                if (!comment) return;
                
                const likedBy = comment.likedBy || {};
                const currentLikes = comment.likes || 0;
                
                if (likedBy[currentUsername]) {
                    // Unlike
                    delete likedBy[currentUsername];
                    await commentRef.update({
                        likes: Math.max(0, currentLikes - 1),
                        likedBy: likedBy
                    });
                } else {
                    // Like
                    likedBy[currentUsername] = true;
                    await commentRef.update({
                        likes: currentLikes + 1,
                        likedBy: likedBy
                    });
                }
                
                loadComments();
            } catch (error) {
                console.warn('Error toggling like:', error);
            }
        }
        
        async function toggleReplyLike(parentId, replyId) {
            if (!currentUsername || parentId.startsWith('temp-')) return;
            
            try {
                const replyRef = database.ref(`comments/${parentId}/replies/${replyId}`);
                const snapshot = await replyRef.once('value');
                const reply = snapshot.val();
                
                if (!reply) return;
                
                const likedBy = reply.likedBy || {};
                const currentLikes = reply.likes || 0;
                
                if (likedBy[currentUsername]) {
                    delete likedBy[currentUsername];
                    await replyRef.update({
                        likes: Math.max(0, currentLikes - 1),
                        likedBy: likedBy
                    });
                } else {
                    likedBy[currentUsername] = true;
                    await replyRef.update({
                        likes: currentLikes + 1,
                        likedBy: likedBy
                    });
                }
                
                loadComments();
            } catch (error) {
                console.warn('Error toggling reply like:', error);
            }
        }
        
        function toggleReplyForm(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            if (replyForm.style.display === 'block') {
                replyForm.style.display = 'none';
            } else {
                // Hide all other reply forms
                document.querySelectorAll('.reply-form').forEach(form => {
                    form.style.display = 'none';
                });
                replyForm.style.display = 'block';
                document.getElementById(`reply-text-${commentId}`).focus();
            }
        }
        
        async function postReply(parentId) {
            if (parentId.startsWith('temp-')) return;
            
            const replyText = document.getElementById(`reply-text-${parentId}`).value.trim();
            if (!replyText || !currentUsername) return;
            
            if (replyText.length > 300) {
                showToast('Reply is too long! Maximum 300 characters.', 'warning');
                return;
            }
            
            try {
                const replyData = {
                    author: currentUsername,
                    text: replyText,
                    timestamp: Date.now(),
                    likes: 0,
                    likedBy: {}
                };
                
                await database.ref(`comments/${parentId}/replies`).push(replyData);
                
                document.getElementById(`reply-text-${parentId}`).value = '';
                document.getElementById(`reply-form-${parentId}`).style.display = 'none';
                loadComments();
            } catch (error) {
                console.warn('Error posting reply:', error);
                showToast('Failed to post reply. Please try again.', 'error');
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'var(--danger)' : 
                           type === 'warning' ? 'var(--warning)' : 
                           'var(--primary)';
            
            toast.style.cssText = `
                position: fixed; top: 80px; right: 20px; z-index: 1002;
                background: ${bgColor}; color: white; padding: 10px 15px;
                border-radius: 5px; font-size: 0.8rem; max-width: 300px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            
            // Add animation keyframes if not exists
            if (!document.getElementById('toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }, 3000);
        }
        
        function cancelReply(commentId) {
            document.getElementById(`reply-form-${commentId}`).style.display = 'none';
            document.getElementById(`reply-text-${commentId}`).value = '';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return new Date(timestamp).toLocaleDateString();
        }
        
        // Initialize level buttons
        function initializeLevelButtons() {
            levelSelector.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = `level-btn ${i === currentLevel ? 'active' : ''} ${i > maxUnlockedLevel ? 'locked' : ''} ${i > 5 ? 'hard' : ''}`;
                btn.dataset.level = i;
                btn.textContent = i;
                
                btn.addEventListener('click', function() {
                    const level = parseInt(this.dataset.level);
                    if (level > maxUnlockedLevel) {
                        document.getElementById('required-level').textContent = level - 1;
                        document.getElementById('unlock-level').textContent = level - 1;
                        gameScreen.style.display = 'none';
                        mobileHeader.style.display = 'none';
                        lockedScreen.style.display = 'block';
                        return;
                    }
                    
                    if (level !== currentLevel) {
                        currentLevel = level;
                        updateActiveLevelButton();
                        updateTopLeaderboard();
                        resetGame();
                    }
                });
                
                levelSelector.appendChild(btn);
            }
        }
        
        // Initialize leaderboard select
        function initializeLeaderboardSelect() {
            leaderboardSelect.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Level ${i}`;
                leaderboardSelect.appendChild(option);
            }
            leaderboardSelect.value = currentLevel;
        }
        
        // Load user data from Firebase - Optimized version
        async function loadUserDataOptimized() {
            try {
                const snapshot = await database.ref('users/' + currentUsername).once('value');
                if (!snapshot.exists()) {
                    // Initialize new user
                    const userData = {
                        scores: Array(10).fill(0),
                        playCount: Array(10).fill(0),
                        lastPlayed: new Date().toISOString(),
                        history: {},
                        maxUnlocked: 1,
                        created: new Date().toISOString()
                    };
                    database.ref('users/' + currentUsername).set(userData).catch(console.error);
                    maxUnlockedLevel = 1;
                } else {
                    const data = snapshot.val();
                    maxUnlockedLevel = data.maxUnlocked || 1;
                }
                
                initializeLevelButtons();
                initializeLeaderboardSelect();
            } catch (error) {
                console.warn('Error loading user data:', error);
                // Continue with defaults
                maxUnlockedLevel = 1;
            }
        }
        
        // Game functions
        function startGame() {
            resetGame();
            updateActiveLevelButton();
        }
        
        function resetGame() {
            clearInterval(timer);
            score = 0;
            timeLeft = getLevelTime();
            gamePaused = false;
            updateDisplay();
            setupRound();
            gameScreen.style.display = 'block';
            endScreen.style.display = 'none';
            gameActive = true;
            gameStartTime = Date.now();
            lastUpdateTime = Date.now();
            
            // Reset pause state
            pauseIndicator.style.display = 'none';
            chatToggleBtn.textContent = 'üí¨ Chat';
            
            // Fixed timer - counts every second precisely
            timer = setInterval(() => {
                if (gameActive && !gamePaused && timeLeft > 0) {
                    timeLeft--;
                    document.getElementById('timer').textContent = timeLeft;
                    
                    if (timeLeft <= 0) {
                        endGame();
                    }
                }
            }, 1000);
        }
        
        function getLevelTime() {
            // Decrease time as level increases
            return Math.max(10, 35 - Math.floor(currentLevel * 2.5));
        }
        
        function setupRound() {
            // Adjust difficulty based on level
            const numOptions = Math.min(4 + Math.floor(currentLevel / 2), 6);
            const colorPoolSize = Math.min(10 + currentLevel * 2, colorNames.length);
            
            colors = [];
            const usedIndices = [];
            
            for (let i = 0; i < numOptions; i++) {
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * colorPoolSize);
                } while (usedIndices.includes(randomIndex));
                
                usedIndices.push(randomIndex);
                colors.push({
                    name: colorNames[randomIndex],
                    value: colorValues[randomIndex]
                });
            }
            
            // Correct answer
            correctIndex = Math.floor(Math.random() * numOptions);
            document.getElementById('target').textContent = colors[correctIndex].name;
            document.getElementById('target').style.color = getTextColor();
            
            // Create options
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            const cols = numOptions <= 4 ? 2 : 3;
            optionsContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            colors.forEach((color, index) => {
                const option = document.createElement('div');
                option.className = 'option';
                option.style.backgroundColor = color.value;
                option.dataset.index = index;
                
                option.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    if (!gamePaused) {
                        showSelectingIndicator(this);
                    }
                });
                
                option.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    if (!gamePaused) {
                        hideSelectingIndicator();
                        checkAnswer(parseInt(this.dataset.index));
                    }
                });
                
                option.addEventListener('mousedown', function() {
                    if (!gamePaused) {
                        showSelectingIndicator(this);
                    }
                });
                
                option.addEventListener('mouseup', function() {
                    if (!gamePaused) {
                        hideSelectingIndicator();
                        checkAnswer(parseInt(this.dataset.index));
                    }
                });
                
                option.addEventListener('mouseleave', hideSelectingIndicator);
                
                optionsContainer.appendChild(option);
            });
        }
        
        function showSelectingIndicator(element) {
            const rect = element.getBoundingClientRect();
            selectingIndicator.style.display = 'block';
            selectingIndicator.style.left = `${rect.left + rect.width/2 - 22}px`;
            selectingIndicator.style.top = `${rect.top + rect.height/2 - 22}px`;
        }
        
        function hideSelectingIndicator() {
            selectingIndicator.style.display = 'none';
        }
        
        function getTextColor() {
            // For higher levels, sometimes make text color different from text meaning
            if (currentLevel > 3 && Math.random() > 0.6) {
                const wrongColors = colors.filter((_, i) => i !== correctIndex);
                return wrongColors[Math.floor(Math.random() * wrongColors.length)].value;
            }
            return colors[correctIndex].value;
        }
        
        function checkAnswer(selectedIndex) {
            if (!gameActive || gamePaused) return;
            
            const now = Date.now();
            if (now - lastUpdateTime < 300) {
                // Prevent rapid clicking
                return;
            }
            lastUpdateTime = now;
            
            const feedback = document.getElementById('feedback');
            
            if (selectedIndex === correctIndex) {
                const pointsEarned = currentLevel * 5;
                score += pointsEarned;
                feedback.textContent = `+${pointsEarned}`;
                feedback.style.color = '#2ecc71';
                
                // Bonus time for streaks
                if (score % (currentLevel * 50) === 0) {
                    timeLeft += 3;
                    feedback.textContent = `+${pointsEarned} (+3s)`;
                }
            } else {
                score = Math.max(0, score - 3);
                feedback.textContent = '-3';
                feedback.style.color = '#e74c3c';
                timeLeft = Math.max(1, timeLeft - 1);
            }
            
            feedback.style.opacity = '1';
            feedback.style.top = (Math.random() * window.innerHeight * 0.6 + 20) + 'px';
            feedback.style.left = (Math.random() * window.innerWidth * 0.8 + 20) + 'px';
            
            setTimeout(() => {
                feedback.style.opacity = '0';
            }, 500);
            
            updateDisplay();
            setupRound();
        }
        
        function updateDisplay() {
            document.getElementById('score').textContent = score;
            document.getElementById('current-level').textContent = currentLevel;
            document.getElementById('current-level-display').textContent = currentLevel;
            document.getElementById('timer').textContent = timeLeft;
            
            if (score > hiScore) {
                hiScore = score;
                document.getElementById('hi-score').textContent = hiScore;
            }
        }
        
        async function updateHiScore() {
            try {
                // Add timeout for hi-score loading
                const scorePromise = database.ref('users/' + currentUsername + '/scores/' + (currentLevel - 1)).once('value');
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Hi-score timeout')), 2000)
                );
                
                const snapshot = await Promise.race([scorePromise, timeoutPromise]);
                hiScore = snapshot.val() || 0;
                document.getElementById('hi-score').textContent = hiScore;
            } catch (error) {
                console.warn('Error loading hi-score:', error);
                hiScore = 0;
                document.getElementById('hi-score').textContent = hiScore;
            }
        }
        
        function updateActiveLevelButton() {
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
                const level = parseInt(btn.dataset.level);
                
                if (level === currentLevel) {
                    btn.classList.add('active');
                }
                
                if (level <= maxUnlockedLevel) {
                    btn.classList.remove('locked');
                } else {
                    btn.classList.add('locked');
                }
                
                if (level > 5) {
                    btn.classList.add('hard');
                }
            });
        }
        
        async function endGame() {
            clearInterval(timer);
            gameActive = false;
            gamePaused = false;
            gameScreen.style.display = 'none';
            mobileHeader.style.display = 'none';
            
            // Close chat if open
            if (chatOpen) {
                closeChat();
            }
            
            // Update end screen
            document.getElementById('end-level').textContent = currentLevel;
            document.getElementById('end-score').textContent = score;
            document.getElementById('end-hiscore').textContent = hiScore;
            
            // Hide continue button if max level
            continueBtn.style.display = currentLevel < 10 ? 'block' : 'none';
            
            try {
                // Game validation
                const gameDuration = Date.now() - gameStartTime;
                if (gameDuration < 3000) { // Minimum 3 seconds per game
                    console.warn('Game too short');
                    endScreen.style.display = 'block';
                    return;
                }
                
                // Update user scores in Firebase
                const nowDate = new Date();
                const updates = {};
                
                // Check if this is a new high score
                const currentHiScoreSnapshot = await database.ref('users/' + currentUsername + '/scores/' + (currentLevel - 1)).once('value');
                const currentHiScore = currentHiScoreSnapshot.val() || 0;
                const isNewHighScore = score > currentHiScore;
                
                if (isNewHighScore) {
                    updates['users/' + currentUsername + '/scores/' + (currentLevel - 1)] = score;
                    hiScore = score;
                }
                
                // Update play count
                const playCountSnapshot = await database.ref('users/' + currentUsername + '/playCount/' + (currentLevel - 1)).once('value');
                const currentPlayCount = playCountSnapshot.val() || 0;
                updates['users/' + currentUsername + '/playCount/' + (currentLevel - 1)] = currentPlayCount + 1;
                
                // Update last played
                updates['users/' + currentUsername + '/lastPlayed'] = nowDate.toISOString();
                
                // Add to history
                const historyKey = nowDate.toISOString().split('T')[0].replace(/-/g, '');
                updates['users/' + currentUsername + '/history/' + historyKey + '/' + nowDate.getTime()] = {
                    level: currentLevel,
                    score: score,
                    timestamp: nowDate.toISOString(),
                    duration: gameDuration
                };
                
                // Check if we should unlock next level
                let levelUnlocked = false;
                if (currentLevel === maxUnlockedLevel && maxUnlockedLevel < 10 && score >= 50) {
                    updates['users/' + currentUsername + '/maxUnlocked'] = maxUnlockedLevel + 1;
                    maxUnlockedLevel++;
                    levelUnlocked = true;
                    
                    // Show unlock message
                    document.getElementById('unlocked-level').textContent = maxUnlockedLevel;
                    document.getElementById('level-unlock-message').style.display = 'block';
                    
                    // Update level buttons
                    initializeLevelButtons();
                } else {
                    document.getElementById('level-unlock-message').style.display = 'none';
                }
                
                await database.ref().update(updates);
                
                // Update leaderboard
                updateTopLeaderboard();
                
                // Show end screen
                endScreen.style.display = 'block';
                
            } catch (error) {
                console.error('Error saving score:', error);
                endScreen.style.display = 'block';
            }
        }
        
        async function showStats() {
            gameScreen.style.display = 'none';
            mobileHeader.style.display = 'none';
            statsScreen.style.display = 'block';
            endScreen.style.display = 'none';
            
            try {
                document.getElementById('stats-username').textContent = currentUsername;
                
                const userSnapshot = await database.ref('users/' + currentUsername).once('value');
                const userStats = userSnapshot.val() || {
                    scores: Array(10).fill(0),
                    playCount: Array(10).fill(0),
                    lastPlayed: new Date().toISOString(),
                    history: {},
                    maxUnlocked: 1
                };
                
                // Show overall stats
                const overallStats = document.getElementById('overall-stats');
                const totalPlays = userStats.playCount.reduce((a, b) => a + b, 0);
                const maxScore = Math.max(...userStats.scores);
                const favoriteLevel = userStats.scores.indexOf(maxScore) + 1;
                
                overallStats.innerHTML = `
                    <p>Total Games Played: ${totalPlays}</p>
                    <p>Highest Score: ${maxScore} (Level ${favoriteLevel})</p>
                    <p>Last Played: ${new Date(userStats.lastPlayed).toLocaleString()}</p>
                    <p>Unlocked Levels: ${userStats.maxUnlocked || 1}/10</p>
                `;
                
                // Set leaderboard to current level
                leaderboardSelect.value = currentLevel;
                
                // Initialize leaderboard
                await updateLeaderboard();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function updateLeaderboard() {
            const selectedLevel = parseInt(leaderboardSelect.value);
            const leaderboardContainer = document.getElementById('leaderboard-container');
            leaderboardContainer.innerHTML = '<p>Loading leaderboard...</p>';
            
            try {
                // Get date ranges for filtering
                const now = new Date();
                let startDate = 0; // All time
                
                if (timeFilter === 'week') {
                    const daysSinceSunday = now.getDay(); // 0 = Sunday
                    const sunday = new Date(now);
                    sunday.setDate(now.getDate() - daysSinceSunday);
                    sunday.setHours(0, 0, 0, 0);
                    startDate = sunday.getTime();
                } else if (timeFilter === 'today') {
                    const today = new Date(now);
                    today.setHours(0, 0, 0, 0);
                    startDate = today.getTime();
                }
                
                // Get all users
                const usersSnapshot = await database.ref('users').once('value');
                const allUsers = usersSnapshot.val() || {};
                
                // Get scores for selected time period
                const scores = [];
                
                for (const username in allUsers) {
                    const userStats = allUsers[username];
                    
                    if (userStats && userStats.history) {
                        for (const dateKey in userStats.history) {
                            for (const timestamp in userStats.history[dateKey]) {
                                const record = userStats.history[dateKey][timestamp];
                                const recordTime = new Date(record.timestamp).getTime();
                                
                                if (record.level === selectedLevel && recordTime >= startDate) {
                                    scores.push({
                                        username: username,
                                        score: record.score,
                                        timestamp: record.timestamp,
                                        duration: record.duration || 0
                                    });
                                }
                            }
                        }
                    }
                }
                
                if (scores.length === 0) {
                    leaderboardContainer.innerHTML = '<p>No records for this period yet</p>';
                    return;
                }
                
                // Filter out suspicious scores
                const filteredScores = scores.filter(score => {
                    if (score.duration > 0 && score.duration < 3000) return false;
                    const maxPossibleScore = Math.floor(score.duration / 1000) * (selectedLevel * 5);
                    if (score.score > maxPossibleScore * 2) return false;
                    return true;
                });
                
                // Sort by score descending
                filteredScores.sort((a, b) => b.score - a.score);
                
                // Get top 20 scores
                const topScores = filteredScores.slice(0, 20);
                
                // Find user's best score and rank
                const userBest = filteredScores.filter(s => s.username === currentUsername)
                                      .sort((a, b) => b.score - a.score)[0];
                
                let userRank = -1;
                if (userBest) {
                    userRank = filteredScores.findIndex(s => s.score <= userBest.score) + 1;
                }
                
                let tableHTML = `
                    <table>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                            <th>Score</th>
                            <th>Date</th>
                        </tr>
                `;
                
                // Add top scores
                topScores.forEach((score, index) => {
                    const isCurrentUser = score.username === currentUsername;
                    const date = new Date(score.timestamp).toLocaleDateString();
                    
                    tableHTML += `
                        <tr ${isCurrentUser ? 'class="highlight"' : ''}>
                            <td>${index + 1}</td>
                            <td>${score.username}${isCurrentUser ? ' (You)' : ''}</td>
                            <td>${score.score}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                });
                
                // Add user's position if not in top 20
                if (userRank > 20 && userBest) {
                    const date = new Date(userBest.timestamp).toLocaleDateString();
                    tableHTML += `
                        <tr><td colspan="4" style="text-align: center;">...</td></tr>
                        <tr class="highlight">
                            <td>${userRank}</td>
                            <td>${userBest.username} (You)</td>
                            <td>${userBest.score}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                }
                
                tableHTML += '</table>';
                
                // Add user's position summary
                if (userBest) {
                    tableHTML += `
                        <div style="margin-top: 15px; text-align: center;">
                            <p>Your best: <strong>${userBest.score}</strong> (Rank #${userRank})</p>
                        </div>
                    `;
                }
                
                leaderboardContainer.innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                leaderboardContainer.innerHTML = '<p>Error loading leaderboard</p>';
            }
        }
        
        async function updateTopLeaderboard() {
            try {
                // Add timeout and fallback
                const leaderboardPromise = database.ref('users').once('value');
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Leaderboard timeout')), 2000)
                );
                
                const usersSnapshot = await Promise.race([leaderboardPromise, timeoutPromise]);
                const allUsers = usersSnapshot.val() || {};
                
                const levelScores = [];
                
                for (const username in allUsers) {
                    const userStats = allUsers[username];
                    if (userStats && userStats.scores && userStats.scores[currentLevel - 1]) {
                        levelScores.push({
                            username: username,
                            score: userStats.scores[currentLevel - 1]
                        });
                    }
                }
                
                // Sort by score descending
                levelScores.sort((a, b) => b.score - a.score);
                
                // Get top 3
                const topScores = levelScores.slice(0, 3);
                
                const topLeaderboard = document.getElementById('top-leaderboard');
                topLeaderboard.innerHTML = '';
                
                if (topScores.length === 0) {
                    topLeaderboard.innerHTML = '<div class="leaderboard-item"><span>No records yet</span></div>';
                } else {
                    topScores.forEach((item, index) => {
                        const div = document.createElement('div');
                        div.className = `leaderboard-item ${item.username === currentUsername ? 'highlight' : ''}`;
                        div.innerHTML = `<span>${index + 1}. ${item.username}${item.username === currentUsername ? ' (You)' : ''}</span> <span>${item.score}</span>`;
                        topLeaderboard.appendChild(div);
                    });
                }
            } catch (error) {
                console.warn('Error loading top leaderboard:', error);
                const topLeaderboard = document.getElementById('top-leaderboard');
                topLeaderboard.innerHTML = '<div class="leaderboard-item"><span>Leaderboard loading...</span></div>';
                
                // Retry after delay
                setTimeout(() => {
                    database.ref('users').once('value').then(snapshot => {
                        const allUsers = snapshot.val() || {};
                        const levelScores = [];
                        
                        for (const username in allUsers) {
                            const userStats = allUsers[username];
                            if (userStats && userStats.scores && userStats.scores[currentLevel - 1]) {
                                levelScores.push({
                                    username: username,
                                    score: userStats.scores[currentLevel - 1]
                                });
                            }
                        }
                        
                        levelScores.sort((a, b) => b.score - a.score);
                        const topScores = levelScores.slice(0, 3);
                        
                        if (topScores.length === 0) {
                            topLeaderboard.innerHTML = '<div class="leaderboard-item"><span>No records yet</span></div>';
                        } else {
                            topLeaderboard.innerHTML = '';
                            topScores.forEach((item, index) => {
                                const div = document.createElement('div');
                                div.className = `leaderboard-item ${item.username === currentUsername ? 'highlight' : ''}`;
                                div.innerHTML = `<span>${index + 1}. ${item.username}${item.username === currentUsername ? ' (You)' : ''}</span> <span>${item.score}</span>`;
                                topLeaderboard.appendChild(div);
                            });
                        }
                    }).catch(() => {
                        topLeaderboard.innerHTML = '<div class="leaderboard-item"><span>No records yet</span></div>';
                    });
                }, 3000);
            }
        }
        
        // Initialize the game
        initializeLevelButtons();
        initializeLeaderboardSelect();
    </script>
</body>
</html>
